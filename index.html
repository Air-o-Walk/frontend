<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air-o-Walk</title>

    <link rel="stylesheet" href="Landing/css/style.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <style>
        #map {
            height: 500px;
            width: 100%;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            z-index: 1;
        }

        .contact-map-container {
            width: 100%;
            height: 300px;
            border-radius: 10px;
            overflow: hidden;
        }

        /* Estilos para las listas de informaci√≥n */
        #gas-text ul {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }

        #gas-text li {
            background: #fff;
            margin-bottom: 8px;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #A8B870;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        #gas-text strong {
            color: #4B4773;
        }

        /* A√±ade esto a tu archivo .css */
        .info.legend {
            padding: 10px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            border-radius: 8px;
            line-height: 20px;
            color: #333;
            max-width: 200px;
        }

        .info.legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 10px;
            opacity: 0.8;
            border: 1px solid rgba(0,0,0,0.2);
            border-radius: 3px;
        }

        .legend-title {
            font-weight: bold;
            text-align: center;
            margin-bottom: 8px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
            font-size: 1.1em;
        }
    </style>
</head>

<body>

    <header class="navbar">
        <div class="nav-left">
            <img src="https://sagucre.upv.edu.es/images/260/21639371/Diagramadesitioweb2-tzmgvOszHG8SDcflHZ0HZw.png"
                class="logo-circle" alt="Air-o-walk logo">
        </div>

        <nav class="nav-links">
            <a href="#maps">Mapa</a>
            <a href="#producto">Nuestro Producto</a>
            <a href="#sobre">Sobre nosotros</a>
            <a href="#contacto">Contacto</a>
        </nav>

        <div class="nav-right">
            <button class="btn-signup"
                onclick="window.location.href='https://sagucre.upv.edu.es/descarga/';">Apuntate!</button>
            <a class="login" href="/login/index.html">Login ></a>
        </div>
    </header>


    <section class="hero">
        <img src="assets/hero.png" class="hero-bg" alt="Hero image">

        <div class="hero-content">
            <h1>Respira mejor</h1>
            <p>Entiende tu aire</p>
            <a href="#maps" class="btn-hero">Ver mapa</a>
        </div>
    </section>


    <section id="maps" class="section-map">

        <h2 class="map-title">Mapa en Tiempo Real</h2>
        <p class="map-sub">Gandia, platja de gandia</p>

        <div id="map"></div>

        <div class="gas-tabs">
            <button class="tab active" onclick="showLayer('AirQuality', this)">Calidad Aire</button>
            <button class="tab" onclick="showLayer('O3', this)">O3</button>
            <button class="tab" onclick="showLayer('CO', this)">CO</button>
            <button class="tab" onclick="showLayer('NO2', this)">NO2</button>
        </div>

        <div class="gas-info">
            <h3 id="gas-title">Calidad del Aire</h3>

            <div id="gas-text">
                <p>El sistema muestra datos en tiempo real de los sensores distribuidos por la ciudad combinando todos
                    los contaminantes.</p>
                <ul>
                    <li><strong>üü¢ Buena:</strong> Disfruta de tus actividades al aire libre.</li>
                    <li><strong>üü° Moderada:</strong> Personas sensibles deben reducir esfuerzos.</li>
                    <li><strong>üü† Mala / üî¥ Muy Mala:</strong> Evita actividades f√≠sicas en el exterior.</li>
                </ul>
            </div>

            <button class="btn-signup map-btn"
                onclick="window.location.href='https://sagucre.upv.edu.es/descarga/';">¬°Descarga la App!</button>
        </div>

    </section>


    <section id="producto" class="section-producto">
        <div class="producto-wrapper">
            <img src="https://sagucre.upv.edu.es/images/260/21639371/Diagramadesitioweb2-tzmgvOszHG8SDcflHZ0HZw.png"
                class="producto-lamp" alt="Logo">
            <div class="producto-content">
                <h2 class="section-title orange center">Nuestro Producto</h2>
                <p class="producto-desc center">
                    Air-o-Walk es una plataforma que combina sensores ambientales, mapas inteligentes y contenido
                    educativo
                    para que cualquier ciudadano pueda entender en tiempo real la calidad del aire que respira.
                </p>
                <div class="producto-grid">
                    <div class="feature-v">
                        <i class="fa-solid fa-map-location-dot icon-feature"></i>
                        <h4>Mapas en tiempo real</h4>
                        <p>Visualiza la calidad del aire con heatmaps precisos.</p>
                    </div>
                    <div class="feature-v">
                        <i class="fa-solid fa-book-open icon-feature"></i>
                        <h4>Educaci√≥n integrada</h4>
                        <p>Fichas simples con causas y consejos pr√°cticos.</p>
                    </div>
                    <div class="feature-v">
                        <i class="fa-solid fa-route icon-feature"></i>
                        <h4>Alertas y Rutas</h4>
                        <p>Recibe avisos y encuentra caminos con menor exposici√≥n.</p>
                    </div>
                    <div class="feature-v">
                        <i class="fa-solid fa-tower-broadcast icon-feature"></i>
                        <h4>Sensores ciudadanos</h4>
                        <p>Combina datos p√∫blicos con nodos de la comunidad.</p>
                    </div>
                </div>
            </div>
        </div>
    </section>


    <section id="sobre" class="section-nosotros">
        <h2 class="section-title orange">Sobre nosotros...</h2>
        <p class="nosotros-desc">
            Somos un equipo joven y multidisciplinar dedicado a crear soluciones tecnol√≥gicas que mejoren la vida
            urbana.
        </p>
        <div class="nosotros-grid">
            <div class="nosotros-card">
                <i class="fa-solid fa-leaf icon-feature"></i>
                <p>Compromiso con la sostenibilidad y la mejora de la calidad del aire.</p>
            </div>
            <div class="nosotros-card">
                <i class="fa-solid fa-mobile-screen icon-feature"></i>
                <p>Tecnolog√≠a accesible para ciudadanos, empresas y administraciones.</p>
            </div>
            <div class="nosotros-card">
                <i class="fa-solid fa-pen-ruler icon-feature"></i>
                <p>Dise√±o centrado en el usuario, simple y educativo.</p>
            </div>
            <div class="nosotros-card">
                <i class="fa-solid fa-database icon-feature"></i>
                <p>Integraci√≥n real de datos procedentes de sensores p√∫blicos y comunitarios.</p>
            </div>
            <div class="nosotros-card">
                <i class="fa-solid fa-lightbulb icon-feature"></i>
                <p>Innovaci√≥n continua, basada en ciencia y desarrollo colaborativo.</p>
            </div>
        </div>
        <div class="nosotros-cta">
            <p>¬øTe animas en participar en este proyecto?</p>
            <button class="btn-signup"
                onclick="window.location.href='https://sagucre.upv.edu.es/descarga/';">Apuntate!</button>
        </div>
    </section>


    <footer id="contacto" class="contact-section">
        <div class="contact-wrapper">
            <div class="contact-left">
                <h2 class="contact-title">¬°Cont√°ctanos!</h2>
                <p class="contact-phone">Tel: +34 965 258 736</p>
                <p class="contact-text">Puedes escribirnos desde aqu√≠:</p>
                <ul class="contact-list">
                    <li>info@airowalk.com</li>
                    <li>soporte@airowalk.com</li>
                    <li>ciudadanos@airowalk.com</li>
                </ul>
                <img src="https://sagucre.upv.edu.es/images/120/21601990/LogoGeneralitatValenciana-8bgziSb98SaymNPrT6-J0Q.png"
                    class="contact-ayto" alt="Generalitat Valenciana">
            </div>

            <div class="contact-right">
                <p class="map-label">Nos puedes encontrar aqu√≠:</p>
                <div class="contact-map-container">
                    <iframe
                        src="https://www.google.com/maps/d/u/0/embed?mid=1spTiPv9xRZlerME3lZ-nqjVBqlVtxdk&ehbc=2E312F"
                        width="100%" height="100%" frameborder="0" style="border:0;" allowfullscreen></iframe>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <img src="https://sagucre.upv.edu.es/images/260/21639371/Diagramadesitioweb2-tzmgvOszHG8SDcflHZ0HZw.png"
                class="footer-logo" alt="Logo">
            <div class="footer-links">
                <a href="#maps">Mapa</a>
                <a href="#producto">Producto</a>
                <a href="#contacto">Contacto</a>
            </div>
            <button class="btn-download" onclick="window.location.href='https://sagucre.upv.edu.es/descarga/';">Descarga
                la app</button>
        </div>
    </footer>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>


    <script>
// --- 1. CONFIGURACI√ìN Y ESTADO ---

const polygonCoords = [
    [39.01828192335328, -0.18187795194988374],
    [39.021449424726455, -0.17496858147487737],
    [38.997231394768725, -0.15589965915302278],
    [38.99286606556935, -0.16121797354713213],
    [38.99423380645311, -0.15306735194865262],
    [38.98673461472112, -0.16113361711015184],
    [38.97372187479627, -0.17283163718753514],
    [38.967505533801656, -0.175903844474732],
    [38.965821209601515, -0.17940931179375955],
    [38.958715983039326, -0.18122112631332885],
    [38.96049235645634, -0.19536115740918147],
    [38.96072175022399, -0.19579010498907135],
    [38.97249142866205, -0.19639560918830187],
    [38.97214906582882, -0.18885432964374718],
    [38.976813619755035, -0.18417543355878388],
    [38.989949748902866, -0.18692772544770195],
    [38.99230286960656, -0.18312956274343764],
    [38.97946671534539, -0.1788910333488238],
    [38.978791164297505, -0.17469549309674834],
    [38.991130397499596, -0.16722174888999147],
    [38.99948758610592, -0.1670379372628237],
    [39.01828192335328, -0.18187795194988374] 
];

const gasInfoData = {
    "AirQuality": {
        title: "Calidad del Aire General",
        text: `<p>√çndice global basado en el contaminante m√°s desfavorable detectado en este intervalo de tiempo.</p>`
    },
    "O3": { title: "Ozono Troposf√©rico (O‚ÇÉ)", text: `<p>Concentraci√≥n de O‚ÇÉ en ¬µg/m¬≥.</p>` },
    "CO": { title: "Mon√≥xido de Carbono (CO)", text: `<p>Concentraci√≥n de CO en ppm.</p>` },
    "NO2": { title: "Di√≥xido de Nitr√≥geno (NO‚ÇÇ)", text: `<p>Concentraci√≥n de NO‚ÇÇ en ¬µg/m¬≥.</p>` }
};

const map = L.map('map').setView([38.9707, -0.1800], 14);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

let rawData = []; 
let interpolationLayer = null;
const layersPoints = { "CO": L.layerGroup(), "O3": L.layerGroup(), "NO2": L.layerGroup(), "AirQuality": L.layerGroup() };
const gasColors = { "co": "#FF4136", "o3": "#0074D9", "no2": "#2ECC40" };

// --- 2. FUNCIONES DE APOYO (HELPERS) ---

function getColor(aqi) {
    console.log("AQI recibido para color:", aqi);
    if (aqi <= 50)  return "#00E400"; // Bueno (Verde)
    if (aqi <= 100) return "#FFFF00"; // Moderado (Amarillo)
    if (aqi <= 150) return "#FF7E00"; // No saludable para sensibles (Naranja)
    if (aqi <= 200) return "#FF0000"; // No saludable (Rojo)
    return "#8F3F97"; // Muy poco saludable (P√∫rpura)
}

// Y para las Isobandas, los breaks son universales:
const aqiBreaks = [0, 25, 50, 75, 100, 125, 150, 175, 200, 500];

function normalize(value, maxExpected) { 
    return Math.min(1, parseFloat(value || 0) / maxExpected); 
}

// --- 3. PROCESADOR DE DATOS (CEREBRO) ---

function getValidPoints(type) {
    return rawData
        .filter(d => d.latitude != null && d.longitude != null)
        .map(d => {
            let aqiValue;
            if (type === "AirQuality") {
                // El AQI general es el peor de los 3
                const aqiCO = calculateAQI(d.co_value, 'CO');
                const aqiO3 = calculateAQI(d.o3_value, 'O3');
                const aqiNO2 = calculateAQI(d.no2_value, 'NO2');
                aqiValue = Math.max(aqiCO || 0, aqiO3 || 0, aqiNO2 || 0);
            } else {
                aqiValue = calculateAQI(d[`${type.toLowerCase()}_value`], type);
            }

            return aqiValue !== null ? turf.point([parseFloat(d.longitude), parseFloat(d.latitude)], { val: aqiValue }) : null;
        })
        .filter(p => p !== null);
}

// --- 4. GENERADOR DE INTERPOLACI√ìN ---

function updateMap(type) {
    if (interpolationLayer) map.removeLayer(interpolationLayer);
    Object.values(layersPoints).forEach(l => map.removeLayer(l));

    const points = getValidPoints(type);
    if (points.length < 5) return; 

    try {
        const collection = turf.featureCollection(points);
        // Aseg√∫rate de que polygonCoords est√© bien definido arriba
        const gandiaPolygon = turf.polygon([polygonCoords.map(c => [c[1], c[0]])]);

        const gridPoints = turf.interpolate(collection, 0.07, {
            gridType: 'points',
            property: 'val',
            units: 'kilometers'
        });

        const aqiBreaks = [0, 25, 50, 75, 100, 125, 150, 175, 200, 500];
        const bands = turf.isobands(gridPoints, aqiBreaks, { zProperty: 'val' });

        // PROCESADO SEGURO DE BANDAS
        const clippedFeatures = [];
        bands.features.forEach(feature => {
            try {
                // Intentamos el intersect. Si falla por versi√≥n, probamos el otro m√©todo
                let intersection = null;
                try {
                    intersection = turf.intersect(feature, gandiaPolygon);
                } catch (err) {
                    // Si falla, intentamos formato v6/v7
                    intersection = turf.intersect(turf.featureCollection([feature, gandiaPolygon]));
                }

                if (intersection) {
                    intersection.properties = feature.properties;
                    clippedFeatures.push(intersection);
                }
            } catch (innerError) {
                console.warn("No se pudo recortar una banda espec√≠fica:", innerError);
            }
        });

        if (clippedFeatures.length === 0) {
            console.error("No hay bandas para mostrar despu√©s del recorte");
            return;
        }

        const clippedBands = {
            type: "FeatureCollection",
            features: clippedFeatures
        };

        interpolationLayer = L.geoJson(clippedBands, {
            style: (feature) => {
                const valString = feature.properties.val || "0-0";
                const lowValue = parseFloat(valString.split('-')[0]);
                
                return {
                    fillColor: getColor(lowValue),
                    fillOpacity: 0.6,
                    weight: 0,
                    color: getColor(lowValue),
                    smoothFactor: 0
                };
            }
        }).addTo(map);


    } catch (e) {
        console.error("Error cr√≠tico en updateMap:", e);
    }
}
// --- 5. GESTOR DE UI Y EVENTOS ---

function showLayer(type, btnElement) {
    updateMap(type);

    // Actualizar botones
    if (btnElement) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        btnElement.classList.add('active');
    }

    // Actualizar Textos
    const info = gasInfoData[type];
    document.getElementById('gas-title').textContent = info.title;
    document.getElementById('gas-text').innerHTML = info.text;
}

/**
 * Calcula el AQI para un contaminante espec√≠fico
 * @param {number} val - Valor crudo (concentraci√≥n)
 * @param {string} type - 'CO', 'NO2', 'O3'
 */
function calculateAQI(val, type) {
    if (val == null || isNaN(val)) return null;

    const breakpoints = {
        'CO': [
            { cpLow: 0.0,  cpHigh: 4.4,  aqLow: 0,   aqHigh: 50 },
            { cpLow: 4.5,  cpHigh: 9.4,  aqLow: 51,  aqHigh: 100 },
            { cpLow: 9.5,  cpHigh: 12.4, aqLow: 101, aqHigh: 150 },
            { cpLow: 12.5, cpHigh: 15.4, aqLow: 151, aqHigh: 200 },
            { cpLow: 15.5, cpHigh: 30.4, aqLow: 201, aqHigh: 300 },
            { cpLow: 30.5, cpHigh: 50.4, aqLow: 301, aqHigh: 500 }
        ],
        'NO2': [
            { cpLow: 0,   cpHigh: 53,  aqLow: 0,   aqHigh: 50 },
            { cpLow: 54,  cpHigh: 100, aqLow: 51,  aqHigh: 100 },
            { cpLow: 101, cpHigh: 360, aqLow: 101, aqHigh: 150 },
            { cpLow: 361, cpHigh: 649, aqLow: 151, aqHigh: 200 },
            { cpLow: 650, cpHigh: 1249, aqLow: 201, aqHigh: 300 },
            { cpLow: 1250, cpHigh: 2049, aqLow: 301, aqHigh: 500 }
        ],
        'O3': [
            { cpLow: 0,   cpHigh: 54,  aqLow: 0,   aqHigh: 50 },
            { cpLow: 55,  cpHigh: 70,  aqLow: 51,  aqHigh: 100 },
            { cpLow: 71,  cpHigh: 85,  aqLow: 101, aqHigh: 150 },
            { cpLow: 86,  cpHigh: 105, aqLow: 151, aqHigh: 200 },
            { cpLow: 106, cpHigh: 200, aqLow: 201, aqHigh: 300 },
            { cpLow: 201, cpHigh: 600, aqLow: 301, aqHigh: 500 }
        ]
    };

    const table = breakpoints[type];
    if (!table) return val;

    // Buscamos el rango. Nota: Usamos una peque√±a tolerancia para los huecos (ej 4.41)
    const range = table.find(r => val >= r.cpLow && val <= r.cpHigh);
    
    if (!range) {
        // Si el valor es m√°s bajo que el m√≠nimo, devolvemos 0
        if (val < table[0].cpLow) return 0;
        // Si el valor supera el m√°ximo de la tabla (AQI > 500)
        return 500; 
    }

    // F√≥rmula oficial de interpolaci√≥n lineal AQI
    const aqi = ((range.aqHigh - range.aqLow) / (range.cpHigh - range.cpLow)) * (val - range.cpLow) + range.aqLow;
    
    return Math.round(aqi);
}

// --- 6. CARGA INICIAL (FETCHER) ---

async function init() {
    try {
        const response = await fetch('https://api.sagucre.upv.edu.es/measurements');
        const data = await response.json();
        rawData = data.measurements || [];

        if (rawData.length === 0) return;

        rawData.forEach(d => {
            const lat = parseFloat(d.latitude);
            const lng = parseFloat(d.longitude);
            if (isNaN(lat) || isNaN(lng)) return;

            // Marcadores para gases individuales
            if (d.co_value != null) layersPoints.CO.addLayer(createMarker(lat, lng, gasColors.co));
            if (d.o3_value != null) layersPoints.O3.addLayer(createMarker(lat, lng, gasColors.o3));
            if (d.no2_value != null) layersPoints.NO2.addLayer(createMarker(lat, lng, gasColors.no2));

            // Marcador para AirQuality (Usando el mismo AQI de la interpolaci√≥n)
            const aqiCO = calculateAQI(d.co_value, 'CO') || 0;
            const aqiO3 = calculateAQI(d.o3_value, 'O3') || 0;
            const aqiNO2 = calculateAQI(d.no2_value, 'NO2') || 0;
            const maxAQI = Math.max(aqiCO, aqiO3, aqiNO2);

            layersPoints.AirQuality.addLayer(L.circleMarker([lat, lng], { 
                radius: 5, 
                fillColor: '#FFF', 
                color: getColor(maxAQI), 
                weight: 3, 
                fillOpacity: 1 
            }));
        });

        showLayer("AirQuality");
        addLegend(); // A√±adir si la tienes definida

    } catch (err) {
        console.error("Error inicial:", err);
    }

    
}

function createMarker(lat, lng, color) {
    return L.circleMarker([lat, lng], { radius: 4, fillColor: color, color: '#000', weight: 1, fillOpacity: 1 });
}

function addLegend() {
    // Si ya existe una leyenda, no la duplicamos
    if (window.mapLegend) {
        window.mapLegend.remove();
    }

    const legend = L.control({ position: 'bottomright' });

    legend.onAdd = function (map) {
        const div = L.DomUtil.create('div', 'info legend');
        
        // Los cortes coinciden con tus colores y l√≥gica de AQI
        const grades = [0, 51, 101, 151];
        const labels = [
            "Bueno", 
            "Moderado", 
            "Sensible", 
            "Insalubre"
        ];

        div.innerHTML = '<div class="legend-title">√çndice AQI</div>';

        // Generamos los items de la leyenda
        for (let i = 0; i < grades.length; i++) {
            const color = getColor(grades[i]);
            const nextGrade = grades[i + 1];
            
            div.innerHTML +=
                '<i style="background:' + color + '"></i> ' +
                 labels[i] + '<br>';
        }

        return div;
    };

    legend.addTo(map);
    window.mapLegend = legend; // Guardamos referencia para poder refrescarla si hace falta
}

init();
    </script>
</body>

</html>  